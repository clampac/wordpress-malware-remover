import shutil
import os
import re
import utils


def replace_wordpress_directories(site_path):
	"""Replace wp-includes and wp-admin directories with the new version."""
	wp_includes_path = os.path.join(site_path, 'htdocs', 'wp-includes')
	wp_admin_path = os.path.join(site_path, 'htdocs', 'wp-admin')
	
	# Remove old directories
	shutil.rmtree(wp_includes_path)
	shutil.rmtree(wp_admin_path)
	
	# Copy new WordPress files
	wordpress_version = get_wordpress_version(site_path)
	wordpress_source = f'/opt/wordpress-malware-remover/wordpress/{wordpress_version}/wordpress'
	
	copy_with_progress(os.path.join(wordpress_source, 'wp-includes'), wp_includes_path)
	copy_with_progress(os.path.join(wordpress_source, 'wp-admin'), wp_admin_path)
	
	utils.log_action(site_path, "WordPress directories replaced.")


def get_wordpress_version(site_path):
	"""Extract the WordPress version from the site."""
	version_file_path = os.path.join(site_path, 'htdocs', 'wp-includes', 'version.php')
	with open(version_file_path, 'r') as file:
		content = file.read()
		version = re.search(r"\$wp_version = '(.+?)';", content).group(1)
	return version


def copy_with_progress(src, dst):
	"""Copy directory with progress bar."""
	total_items = sum([len(dirs) + len(files) for _, dirs, files in os.walk(src)])
	processed_items = 0
	
	shutil.copytree(src, dst, dirs_exist_ok=True,
	                copy_function=lambda src, dst: _copy_file_with_progress(src, dst, total_items, processed_items))


def _copy_file_with_progress(src, dst, total_items, processed_items):
	shutil.copy2(src, dst)
	processed_items += 1
	utils.progress_bar(total_items, processed_items)


if __name__ == "__main__":
	import sys
	
	site_path = sys.argv[1]
	utils.setup_logging(site_path)
	replace_wordpress_directories(site_path)
