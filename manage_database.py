import os
import re
import mysql.connector
import utils
import secrets


def manage_database(wp_config_path, root_password):
	"""Manage database: create new user, update wp-config.php, and remove old users."""
	site_path = os.path.dirname(wp_config_path)
	db_user, db_password, db_name = get_db_credentials(wp_config_path)
	new_db_user, new_db_password = create_new_db_user(db_name, root_password)
	
	# Update wp-config.php with new credentials
	update_wp_config(wp_config_path, new_db_user, new_db_password)
	
	# Remove old users
	remove_old_db_users(db_name, root_password, new_db_user)
	
	utils.log_action(site_path, "Database management completed.")


def get_db_credentials(wp_config_path):
	"""Extract DB_USER, DB_PASSWORD, and DB_NAME from wp-config.php."""
	db_user = None
	db_password = None
	db_name = None
	with open(wp_config_path, 'r') as file:
		for line in file:
			if "DB_USER" in line:
				db_user = re.search(r"define\(\s*'DB_USER'\s*,\s*'(.+?)'\s*\);", line).group(1)
			if "DB_PASSWORD" in line:
				db_password = re.search(r"define\(\s*'DB_PASSWORD'\s*,\s*'(.+?)'\s*\);", line).group(1)
			if "DB_NAME" in line:
				db_name = re.search(r"define\(\s*'DB_NAME'\s*,\s*'(.+?)'\s*\);", line).group(1)
	return db_user, db_password, db_name


def create_new_db_user(db_name, root_password):
	"""Create a new database user with a secure password."""
	new_db_user = f'user_{secrets.token_hex(8)}'
	new_db_password = secrets.token_urlsafe(16)
	cnx = mysql.connector.connect(user='root', password=root_password)
	cursor = cnx.cursor()
	cursor.execute(f"CREATE USER '{new_db_user}'@'localhost' IDENTIFIED BY '{new_db_password}';")
	cursor.execute(f"GRANT ALL PRIVILEGES ON {db_name}.* TO '{new_db_user}'@'loca
