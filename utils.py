import os
import re
import shutil
import requests


def get_wordpress_version(wp_install_path):
	"""Extract the WordPress version from the site."""
	version_file_path = os.path.join(wp_install_path, 'wp-includes', 'version.php')
	if not os.path.exists(version_file_path):
		raise FileNotFoundError(f"No such file or directory: '{version_file_path}'")
	with open(version_file_path, 'r') as file:
		content = file.read()
		version = re.search(r"\$wp_version = '(.+?)';", content).group(1)
	return version


def get_wordpress_language(wp_install_path):
	"""Extract the WordPress language from the site."""
	language_file_path = os.path.join(wp_install_path, 'wp-includes', 'l10n.php')
	if not os.path.exists(language_file_path):
		raise FileNotFoundError(f"No such file or directory: '{language_file_path}'")
	with open(language_file_path, 'r') as file:
		content = file.read()
		language = re.search(r"\$wp_local_package = '(.+?)';", content).group(1)
	return language


def choose_wordpress_language():
	"""Prompt the user to choose a language for the WordPress version."""
	languages = {
		'1': 'en_US',
		'2': 'es_ES',
		'3': 'de_DE',
		'4': 'fr_FR',
		'5': 'it_IT',
		'6': 'ja',
		'7': 'pt_BR'
	}
	
	print("Available languages:")
	print("1. English (United States)")
	print("2. Spanish (Spain)")
	print("3. German")
	print("4. French")
	print("5. Italian")
	print("6. Japanese")
	print("7. Portuguese (Brazil)")
	
	choice = input("Enter the number of the language to use: ").strip()
	return languages[choice]


def download_wordpress_version(version, language):
	"""Download the specified WordPress version in the specified language."""
	download_url = f"https://{language}.wordpress.org/wordpress-{version}-{language}.tar.gz"
	download_path = f'/opt/wordpress-malware-remover/downloads/wordpress-{version}-{language}.tar.gz'
	response = requests.get(download_url, stream=True)
	
	with open(download_path, 'wb') as file:
		for chunk in response.iter_content(chunk_size=8192):
			file.write(chunk)
	
	extract_path = f'/opt/wordpress-malware-remover/wordpress/{version}'
	shutil.unpack_archive(download_path, extract_path)
